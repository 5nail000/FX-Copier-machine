# Копировщик сделок MT5

Система автоматического копирования сделок между терминалами MetaTrader 5.

## Описание

Копировщик следит за открытием и закрытием позиций на донорском (родительском) аккаунте и автоматически копирует их на клиентский аккаунт с использованием лимитных ордеров для обеспечения лучшей цены входа/выхода.

## Основные возможности

- Автоматический поиск и подключение к терминалам MT5 с указанными аккаунтами
- Мониторинг открытия новых позиций на донорском аккаунте
- Размещение лимитных ордеров с адаптивным отступом от рыночной цены
- Обеспечение цены входа не хуже оригинальной
- Автоматическое закрытие позиций при закрытии на донорском аккаунте
- Поддержка различных режимов расчета размера лота (фиксированный, пропорция, автолот)

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте файл `app_config.json` на основе примера `app_config.json.example`:
```bash
cp app_config.json.example app_config.json
```

3. Отредактируйте `app_config.json`, указав:
   - Номер клиентского аккаунта (только номер!)
   - Настройки размера лота
   - Параметры ордеров

4. (Опционально) Создайте файл `donors_config.json` для настройки доноров (см. `donors_config.json.example`)

**ВАЖНО:** 
- Клиентский аккаунт должен быть авторизован в запущенном терминале MT5
- Донорские аккаунты настраиваются через `donors_config.json` или аргументы командной строки
- Скрипт автоматически найдет терминалы, где авторизованы указанные аккаунты

## Использование

### Базовое использование

Запустите скрипт:
```bash
python main.py
```

Скрипт будет:
1. Искать запущенные терминалы MT5
2. Подключаться к донорскому и клиентскому аккаунтам
3. Мониторить открытие новых позиций
4. Копировать позиции с использованием лимитных ордеров
5. Закрывать позиции при закрытии на донорском аккаунте

### Опции командной строки

#### Множественные доноры (рекомендуется)

По умолчанию система автоматически пытается загрузить файл `donors_config.json` из корня проекта.

```bash
# Автоматическая загрузка donors_config.json из корня
python main.py

# Указать другой конфигурационный файл
python main.py --donors-config custom_donors.json

# Игнорировать конфиг и использовать аргументы командной строки
python main.py --ignore-donor-config --donor-api 12345678
```

**Примечание:** 
- Если файл `donors_config.json` не найден, система выведет информационное сообщение
- Для работы с сокет-донорами необходимо установить и запустить соответствующие EA в терминалах MT4/MT5
- Подробности см. в `donors/README_DONORS.md`
- Пример конфигурации: `donors_config.json.example`

#### Быстрый запуск одного донора

Опции `--donor-api`, `--donor-socket-mt4`, `--donor-socket-mt5` автоматически отменяют загрузку конфигурационного файла.

```bash
# Один донор через Python API MT5 (система найдет терминал автоматически)
python main.py --donor-api 12345678

# Один донор через Socket MT5
python main.py --donor-socket-mt5 12345678 --socket-port 8888

# Один донор через Socket MT4
python main.py --donor-socket-mt4 12345678 --socket-port 8888
```

#### Оптимизация ордеров

```bash
# Оптимизировать все ордера (открывающие и закрывающие) к текущей рыночной цене
python main.py --optimize-to-market

# По умолчанию (без опции) - оптимизация к оригинальной цене открытия/закрытия
python main.py
```

#### Отступ для лимитных ордеров

```bash
# Установить отступ в 3 пункта от рыночной цены для лимитных ордеров
python main.py --limit-offset-points 3.0

# По умолчанию используется отступ 2.0 пункта
python main.py
```

**Примечание:** Отступ применяется к открывающим и закрывающим лимитным ордерам. Для BUY_LIMIT отступ считается от ask (вниз), для SELL_LIMIT - от bid (вверх).

#### Копирование Stop Loss и Take Profit

```bash
# Копировать SL/TP с донорских позиций на клиентские
python main.py --copy-sl-tp

# Комбинирование опций
python main.py --copy-sl-tp --optimize-to-market
```

**Примечание:** При включении опции `--copy-sl-tp` система будет копировать значения Stop Loss и Take Profit с донорских позиций на клиентские ордера (как для лимитных, так и для рыночных ордеров).

#### Копирование отложенных ордеров

```bash
# Копировать отложенные ордера (BUY_LIMIT, SELL_LIMIT, BUY_STOP, SELL_STOP и т.д.) с донорского аккаунта
python main.py --copy-pending-orders

# Комбинирование опций
python main.py --copy-pending-orders --copy-sl-tp --limit-offset-points 2.0
```

**Примечание:** 
- При включении опции `--copy-pending-orders` система будет автоматически копировать все отложенные ордера (лимитные, стоп-ордера, стоп-лимитные) с донорского аккаунта на клиентский
- При исполнении отложенного ордера донора система автоматически связывает позиции, предотвращая дублирование
- При удалении отложенного ордера донора соответствующий клиентский ордер автоматически отменяется
- Поддерживаются все типы отложенных ордеров: BUY_LIMIT, SELL_LIMIT, BUY_STOP, SELL_STOP, BUY_STOP_LIMIT, SELL_STOP_LIMIT
- Если включена опция `--copy-sl-tp`, SL/TP будут скопированы и на отложенные ордера

#### Копирование существующих позиций

```bash
# Копировать уже открытые позиции при запуске программы
python main.py --copy-existing-positions

# Комбинирование опций
python main.py --copy-existing-positions --optimize-to-market
```

#### Копирование Magic Number

```bash
# Копировать magic number с донорских позиций вместо использования значения из конфига
python main.py --copy-donor-magic

# Комбинирование опций
python main.py --copy-existing-positions --copy-donor-magic --optimize-to-market
```

**Примечание:** При использовании `--copy-donor-magic` система будет копировать magic number с донорских позиций на клиентские ордера. Это полезно, если вы хотите сохранить идентификацию позиций между донором и клиентом. Если опция не указана, используется фиксированное magic number из конфигурации (`MAGIC_NUMBER`).

#### Отображение снэпшота позиций

```bash
# Показать снэпшот всех позиций при первой загрузке
python main.py --show-snapshot

# Комбинирование опций
python main.py --show-snapshot --copy-existing-positions --copy-donor-magic
```

**Примечание:** Опция `--show-snapshot` выводит подробный снэпшот всех позиций на донорском и клиентском аккаунтах при первом запуске программы. Снэпшот включает полные данные о позициях (ticket, symbol, type, volume, price, magic, time, comment) и информацию о связях между донорскими и клиентскими позициями, включая разницы в ценах и времени открытия. По умолчанию снэпшот не выводится.

#### Стиль копирования

```bash
# Использовать стиль By_Market (мгновенное открытие/закрытие по маркету)
python main.py --copy-style by_market

# Использовать стиль By_Limits (лимитные ордера с оптимизацией, по умолчанию)
python main.py --copy-style by_limits

# Комбинирование опций
python main.py --copy-style by_market --copy-existing-positions --copy-donor-magic
```

**Примечание:** 
- **By_Limits** (по умолчанию): Использует лимитные ордера для обеспечения лучшей или равной цены входа/выхода. Ордера оптимизируются, приближаясь к оригинальной цене. Закрытие происходит через размещение встречного лимитного ордера и использование `TRADE_ACTION_CLOSE_BY`
- **By_Market**: Мгновенное открытие и закрытие позиций по рыночной цене. Позиции открываются и закрываются сразу при поступлении команды с донорского аккаунта через `TRADE_ACTION_DEAL`

## Полный список опций командной строки

### Доноры

| Опция | Тип | Описание |
|-------|-----|----------|
| `--donors-config FILE` | строка | Путь к JSON файлу с конфигурацией доноров (по умолчанию: `donors_config.json` в корне проекта) |
| `--ignore-donor-config` | флаг | Игнорировать конфигурационный файл `donors_config.json` и использовать только аргументы командной строки |
| `--donor-api ACCOUNT` | число | Один донор через Python API MT5 (номер аккаунта, система найдет терминал автоматически). Отменяет загрузку конфига |
| `--donor-socket-mt4 ACCOUNT` | число | Один донор через Socket MT4 (номер аккаунта, подключение к MQL4 EA). Отменяет загрузку конфига |
| `--donor-socket-mt5 ACCOUNT` | число | Один донор через Socket MT5 (номер аккаунта, подключение к MQL5 EA). Отменяет загрузку конфига |
| `--socket-host HOST` | строка | Хост для сокет-подключений (по умолчанию: `localhost`) |
| `--socket-port PORT` | число | Порт для сокет-подключений (по умолчанию: `8888`, используется только с `--donor-socket-*`) |

### Настройки лота

| Опция | Тип | Описание | По умолчанию |
|-------|-----|----------|--------------|
| `--lot-mode MODE` | выбор | Режим расчета лота: `fixed` (фиксированный), `proportion` (пропорциональный), `autolot` (автолот по балансу) | `fixed` |
| `--lot-value VALUE` | число | Значение для расчета лота (для `fixed` - размер лота, для `proportion` - коэффициент) | `0.01` |
| `--min-lot VALUE` | число | Минимальный размер лота | `0.01` |
| `--max-lot VALUE` | число | Максимальный размер лота | `100.0` |

### Общие настройки

| Опция | Тип | Описание | По умолчанию |
|-------|-----|----------|--------------|
| `--client-account ACCOUNT` | число | Номер клиентского аккаунта (переопределяет значение из `app_config.json`) | из конфига |
| `--check-interval SECONDS` | число | Интервал проверки позиций в секундах | `0.05` |
| `--copy-style STYLE` | строка | Стиль копирования: `by_limits` (лимитные ордера с оптимизацией) или `by_market` (мгновенное открытие/закрытие по маркету) | `by_limits` |

### Поведение программы

| Опция | Тип | Описание |
|-------|-----|----------|
| `--optimize-to-market` | флаг | Оптимизировать все ордера (открывающие и закрывающие) к текущей рыночной цене. По умолчанию - к оригинальной цене |
| `--limit-offset-points POINTS` | число | Отступ в пунктах от рыночной цены для лимитных ордеров (открывающих и закрывающих). По умолчанию: 2.0 |
| `--copy-sl-tp` | флаг | Копировать Stop Loss и Take Profit с донорских позиций на клиентские |
| `--copy-pending-orders` | флаг | Копировать отложенные ордера (BUY_LIMIT, SELL_LIMIT, BUY_STOP, SELL_STOP и т.д.) с донорского аккаунта |
| `--copy-existing-positions` | флаг | Копировать уже открытые позиции при запуске программы |
| `--copy-donor-magic` | флаг | Копировать magic number с донорских позиций вместо использования значения из конфига |
| `--show-snapshot` | флаг | Показать снэпшот всех позиций при первой загрузке |

### Примеры комбинирования опций

```bash
# Полный пример с множественными настройками (By_Limits)
python main.py \
  --donors-config donors.json \
  --client-account 87654321 \
  --lot-mode proportion \
  --lot-value 0.5 \
  --min-lot 0.01 \
  --max-lot 10.0 \
  --check-interval 0.5 \
  --copy-style by_limits \
  --copy-existing-positions \
  --copy-donor-magic \
  --show-snapshot

# Быстрый запуск с минимальными настройками (By_Market)
python main.py --donor-api 12345678 --client-account 87654321 --lot-value 0.1 --check-interval 0.05 --copy-style by_market

# Быстрый запуск с минимальными настройками (By_Limits, по умолчанию)
python main.py --donor-api 12345678 --client-account 87654321 --lot-value 0.1 --check-interval 0.05
```

## Настройки

### Режимы расчета лота

Настраиваются в файле `app_config.json` в секции `lot_config` или через аргументы командной строки:

- **fixed**: Фиксированный размер лота (задается в `lot_config.value` или `--lot-value`)
- **proportion**: Пропорциональный размер (донорский лот × `lot_config.value` или `--lot-value`)
- **autolot**: Автоматический расчет на основе соотношения балансов

Пример конфигурации в `app_config.json`:
```json
{
  "lot_config": {
    "mode": "fixed",
    "value": 0.01,
    "min_lot": 0.01,
    "max_lot": 100.0
  }
}
```

Или через аргументы командной строки:
```bash
python main.py --lot-mode fixed --lot-value 0.01 --min-lot 0.01 --max-lot 100.0
```

### Параметры ордеров

Все параметры настраиваются в файле `app_config.json` или через аргументы командной строки:

- `order_config.max_retries`: Максимальное количество попыток размещения ордера (по умолчанию: 10)
- `order_config.magic`: Магическое число для идентификации ордеров, открытых копировщиком (по умолчанию: 234000)
- `order_config.limit_offset_points`: Отступ в пунктах от рыночной цены для лимитных ордеров (по умолчанию: 2.0)
- `order_config.copy_sl_tp`: Копировать Stop Loss и Take Profit с донорских позиций (по умолчанию: false)
- `order_config.copy_pending_orders`: Копировать отложенные ордера с донорского аккаунта (по умолчанию: false)

Пример конфигурации в `app_config.json`:
```json
{
  "order_config": {
    "max_retries": 50,
    "magic": 234000,
    "limit_offset_points": 2.0,
    "copy_sl_tp": false,
    "copy_pending_orders": false
  }
}
```

**Важно:** 
- Система начинает размещение лимитных ордеров с отступом, указанным в `limit_offset_points` (по умолчанию 2 пункта от рыночной цены). При отклонении брокером цена увеличивается на один пункт (point) символа до принятия ордера.
- Для BUY_LIMIT отступ считается от ask (цена ордера = ask - offset), для SELL_LIMIT - от bid (цена ордера = bid + offset).
- Если оригинальная цена лучше (ближе к рынку), используется она вместо цены с отступом.

### Настройки через аргументы командной строки

Все настройки можно переопределить через аргументы командной строки:

```bash
# Настройки лота
python main.py --lot-mode proportion --lot-value 0.5 --min-lot 0.01 --max-lot 10.0

# Интервал проверки
python main.py --check-interval 0.5

# Комбинирование
python main.py --lot-mode fixed --lot-value 0.1 --check-interval 0.05
```

## Структура проекта

- `main.py` - Главный файл, запуск системы
- `config.py` - Конфигурация и настройки
- `terminal_manager.py` - Управление подключениями к терминалам MT5 через multiprocessing
- `terminal_worker.py` - Рабочие процессы для каждого терминала
- `position_monitor.py` - Мониторинг позиций на донорском аккаунте
- `order_manager.py` - Управление ордерами на клиентском аккаунте
- `utils.py` - Вспомогательные функции
- `donors/` - Модуль для работы с множественными донорами
  - `donor_base.py` - Базовые классы для всех типов доноров
  - `donor_manager.py` - Менеджер всех доноров
  - `donor_python_api.py` - Донор через Python API MT5
  - `donor_socket_mt4.py` - Донор через Socket MT4
  - `donor_socket_mt5.py` - Донор через Socket MT5
  - `socket_client.py` - Клиент для подключения к EA через сокет
  - `donor_config_loader.py` - Загрузчик конфигурации из JSON
  - `DonorBroadcasterMT4.mq4` - EA для MT4 (трансляция данных)
  - `DonorBroadcasterMT5.mq5` - EA для MT5 (трансляция данных)
  - `README_DONORS.md` - Документация по работе с донорами

## Важные замечания

1. Оба терминала MT5 должны быть запущены перед запуском скрипта
2. **Аккаунты должны быть авторизованы в соответствующих терминалах** - скрипт автоматически найдет нужные терминалы
3. Донорский и клиентский аккаунты должны находиться в разных терминалах
4. Убедитесь, что у клиентского аккаунта достаточно средств для открытия позиций
5. **Стили копирования**: Система поддерживает два стиля копирования:
   - **By_Limits** (по умолчанию): Использует лимитные ордера (BUY_LIMIT/SELL_LIMIT) для обеспечения лучшей или равной цены входа/выхода. Ордера оптимизируются, приближаясь к оригинальной цене. Закрытие происходит через размещение встречного лимитного ордера и использование `TRADE_ACTION_CLOSE_BY`
   - **By_Market**: Мгновенное открытие и закрытие позиций по рыночной цене. Позиции открываются и закрываются сразу при поступлении команды с донорского аккаунта
6. **Отступ для лимитных ордеров** (только для By_Limits): Система размещает лимитные ордера с отступом от рыночной цены (по умолчанию 2 пункта). Для BUY_LIMIT отступ считается от ask (вниз), для SELL_LIMIT - от bid (вверх). Если оригинальная цена лучше (ближе к рынку), используется она. При отклонении брокером цена увеличивается на один пункт до принятия ордера. Отступ настраивается через `--limit-offset-points` или `order_config.limit_offset_points`
7. **Оптимизация ордеров** (только для By_Limits): Размещенные ордера постоянно оптимизируются, приближаясь к оригинальной цене (или к рыночной, если указана опция `--optimize-to-market`)
8. **Закрытие позиций**:
   - **By_Limits**: Закрытие происходит через размещение встречного лимитного ордера и последующее использование `TRADE_ACTION_CLOSE_BY` для явного закрытия позиций
   - **By_Market**: Позиции закрываются мгновенно по рыночной цене через `TRADE_ACTION_DEAL`
9. **Пароли и серверы не требуются** - скрипт использует уже авторизованные сессии в терминалах
10. **Многопроцессная архитектура**: Скрипт использует multiprocessing для одновременной работы с обоими терминалами. Каждый терминал работает в отдельном процессе, что обеспечивает полную изоляцию и параллельность
11. **Рекомендуемый интервал**: Минимальный интервал проверки - 0.05 секунды (50 мс). Благодаря многопроцессной архитектуре оба терминала работают параллельно без переключений
12. **Magic Number**: Все ордера, размещенные копировщиком, имеют уникальное магическое число для идентификации (по умолчанию: 234000). Используйте опцию `--copy-donor-magic` для копирования magic number с донорских позиций
13. **Копирование существующих позиций**: Используйте опцию `--copy-existing-positions` для копирования уже открытых позиций при запуске программы
14. **Копирование SL/TP**: Используйте опцию `--copy-sl-tp` для копирования Stop Loss и Take Profit с донорских позиций на клиентские ордера. Работает как для лимитных, так и для рыночных ордеров
15. **Копирование отложенных ордеров**: Используйте опцию `--copy-pending-orders` для автоматического копирования всех отложенных ордеров (BUY_LIMIT, SELL_LIMIT, BUY_STOP, SELL_STOP и т.д.) с донорского аккаунта. При исполнении ордера система автоматически связывает позиции, предотвращая дублирование. При удалении ордера донора соответствующий клиентский ордер автоматически отменяется
16. **Множественные доноры**: Система поддерживает работу с несколькими донорами одновременно через разные источники (Python API, Socket MT4, Socket MT5). По умолчанию автоматически загружается файл `donors_config.json` из корня проекта. Опции `--donor-api`, `--donor-socket-mt4`, `--donor-socket-mt5` и `--ignore-donor-config` отменяют загрузку конфига. Подробности см. в `donors/README_DONORS.md`
17. **Сокет-доноры**: Для работы с донорами через сокет установите и запустите соответствующие EA (`DonorBroadcasterMT4.mq4` или `DonorBroadcasterMT5.mq5`) в терминалах MT4/MT5

## Остановка

Нажмите `Ctrl+C` для корректной остановки скрипта.

