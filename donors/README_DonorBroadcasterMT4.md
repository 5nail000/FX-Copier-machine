# DonorBroadcasterMT4.mq4 - Инструкция по установке и настройке

Expert Advisor (EA) для MetaTrader 4, который транслирует данные о позициях и ордерах через TCP сокет для копировщика сделок.

## Описание

`DonorBroadcasterMT4.mq4` - это EA для MT4, который:
- Создает TCP сервер на указанном порту
- Отслеживает изменения позиций и ордеров
- Отправляет данные только при реальных изменениях (оптимизация нагрузки)
- Транслирует информацию об аккаунте, позициях и ордерах в формате JSON

**Важно:** EA **не открывает и не закрывает сделки** - он только читает данные о существующих позициях и ордерах и транслирует их через сокет.

## Требования

- MetaTrader 4 (любая версия)
- Windows (для работы WinSock2)
- Разрешение на автоматическую торговлю в терминале (требование терминала MT4 для запуска любых EA, не для торговли)
- Python копировщик сделок для подключения к EA

## Установка

### Шаг 1: Копирование файлов

1. Найдите папку данных вашего терминала MT4:
   ```
   C:\Users\<ВашеИмя>\AppData\Roaming\MetaQuotes\Terminal\<ID_Терминала>\MQL4\
   ```

2. Скопируйте файлы в соответствующие папки:
   - `DonorBroadcasterMT4.mq4` → `MQL4\Experts\`
   - `WinSock2.mqh` → `MQL4\Include\` (или в ту же папку, что и `.mq4` файл)

   **Важно:** Файл `WinSock2.mqh` должен быть доступен для компиляции. Если вы скопировали его в папку `Include`, используйте в коде:
   ```mql4
   #include <WinSock2.mqh>  // с угловыми скобками
   ```
   
   Если файл в той же папке, что и `.mq4`:
   ```mql4
   #include "WinSock2.mqh"  // с кавычками (текущая настройка)
   ```

### Шаг 2: Компиляция

1. Откройте MetaEditor (F4 в терминале MT4 или через меню Tools → MetaQuotes Language Editor)
2. В навигаторе найдите файл `DonorBroadcasterMT4.mq4` в папке `Experts`
3. Откройте файл двойным кликом
4. Нажмите кнопку "Compile" (F7) или выберите Tools → Compile
5. Проверьте вкладку "Errors" - не должно быть ошибок компиляции

### Шаг 3: Установка на график

1. В терминале MT4 откройте любой график (например, EURUSD)
2. В навигаторе найдите `DonorBroadcasterMT4` в папке `Expert Advisors`
3. Перетащите EA на график
4. В появившемся окне настройте параметры (см. раздел "Параметры")
5. Убедитесь, что включены галочки:
   - ✅ "Allow live trading" (Разрешить автоматическую торговлю) - **требование терминала MT4 для запуска EA, EA не торгует**
   - ✅ "Allow DLL imports" (Разрешить импорт DLL) - необходимо для работы сокетов
6. Нажмите "OK"

### Шаг 4: Проверка работы

1. В правом верхнем углу графика должна появиться иконка EA (смайлик, если работает)
2. Откройте вкладку "Journal" (Вид → Журнал) и проверьте сообщения:
   ```
   Сервер запущен на порту 8888
   Ожидание подключения клиента...
   ```
3. После подключения Python клиента появится:
   ```
   Клиент подключен!
   ```

## Параметры

При установке EA на график можно настроить следующие параметры:

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `SocketPort` | int | 8888 | Порт TCP сокета для подключения клиента |
| `UpdateInterval` | int | 100 | **Не используется** (оставлен для совместимости). Данные отправляются только при реальных изменениях |

### Рекомендации по настройке порта

- Используйте порты в диапазоне 1024-65535
- Если запускаете несколько EA на одном компьютере, используйте разные порты (8888, 8889, 8890 и т.д.)
- Убедитесь, что порт не занят другим приложением
- Проверьте настройки брандмауэра Windows

## Как это работает

### Механизм оптимизации

EA использует интеллектуальную систему отслеживания изменений:

1. **Событийная модель**: `OnTick()` вызывается при каждом тике цены
2. **Проверка изменений**: EA сравнивает текущее состояние с предыдущим
3. **Отправка только при изменениях**: Данные отправляются только когда:
   - Изменился баланс аккаунта
   - Открылась/закрылась позиция или ордер
   - Изменился SL/TP позиции или ордера
   - Изменился объем позиции (частичное закрытие)
   - Сменился аккаунт

**Не отправляется при:**
- Изменении профита (меняется на каждом тике)
- Изменении эквити (меняется на каждом тике при наличии позиций)
- Простых колебаниях цены без изменений позиций

### Формат данных

EA отправляет данные в формате JSON:

```json
{
  "type": "positions",
  "timestamp": 1234567890,
  "account_info": {
    "login": 12345678,
    "balance": 10000.00,
    "equity": 10050.00,
    "server": "Broker-Demo"
  },
  "positions": [
    {
      "ticket": 123456,
      "symbol": "EURUSD",
      "type": 0,
      "volume": 0.10,
      "price_open": 1.08500,
      "price_current": 1.08550,
      "sl": 1.08000,
      "tp": 1.09000,
      "profit": 5.00,
      "time": 1234567890,
      "magic": 234000,
      "comment": "Comment"
    }
  ],
  "orders": [
    {
      "ticket": 789012,
      "symbol": "EURUSD",
      "type": 2,
      "volume": 0.10,
      "price_open": 1.08500,
      "sl": 1.08000,
      "tp": 1.09000,
      "time_setup": 1234567890
    }
  ]
}
```

### Протокол передачи

1. EA создает TCP сервер на указанном порту
2. Python клиент подключается к серверу
3. При каждом изменении EA отправляет:
   - 4 байта (big-endian) - длина JSON сообщения
   - N байт - JSON данные
4. При первом подключении отправляется полное состояние аккаунта

## Настройка Python клиента

В файле `config/donors_config.json` добавьте донора типа `socket_mt4`:

```json
{
  "donors": [
    {
      "id": "donor_mt4_1",
      "type": "socket_mt4",
      "account_number": 12345678,
      "host": "localhost",
      "port": 8888,
      "description": "Донор MT4 через сокет"
    }
  ]
}
```

Или используйте аргументы командной строки:

```bash
python main.py --donor-socket-mt4 12345678 --socket-port 8888
```

## Отладка

### EA не компилируется

**Ошибка: "can't open WinSock2.mqh"**
- Убедитесь, что файл `WinSock2.mqh` скопирован в правильную папку
- Проверьте путь в `#include` директиве
- Попробуйте использовать полный путь или скопировать файл в папку `Include`

**Ошибки компиляции WinSock**
- Убедитесь, что включен "Allow DLL imports" в настройках EA
- Проверьте, что файл `ws2_32.dll` доступен в системе Windows

### EA не запускается

**EA не появляется на графике**
- Проверьте вкладку "Errors" в MetaEditor
- Убедитесь, что файл скомпилирован без ошибок
- Проверьте, что включена автоматическая торговля (кнопка "AutoTrading" в терминале)

**EA показывает ошибки в журнале**
- "Ошибка инициализации WinSock" - проблема с DLL, перезапустите терминал
- "Ошибка создания сокета" - порт может быть занят, попробуйте другой порт
- "Ошибка привязки сокета" - порт занят или нет прав доступа

### Клиент не подключается

**Python клиент не может подключиться**
1. Проверьте, что EA запущен и показывает "Сервер запущен на порту XXXX"
2. Убедитесь, что порт в конфигурации Python совпадает с портом EA
3. Проверьте настройки брандмауэра Windows
4. Попробуйте подключиться через `telnet localhost 8888` (должно подключиться)

**Данные не приходят**
1. Проверьте логи Python приложения
2. Убедитесь, что на аккаунте есть открытые позиции или ордера
3. Проверьте журнал терминала MT4 на наличие ошибок

## Особенности MT4

### Отличия от MT5 версии

- В MT4 позиции - это ордера типа `OP_BUY` или `OP_SELL`
- Используются функции `Order*` вместо `Position*`
- Режим `#property strict` требует более строгого синтаксиса

### Ограничения

- EA должен работать на аккаунте, который указан в конфигурации донора
- Один EA = один аккаунт
- Для нескольких аккаунтов запускайте несколько EA с разными портами

## Безопасность

⚠️ **Важные замечания:**

- EA открывает TCP порт на локальной машине
- Рекомендуется использовать только на локальном компьютере
- Не открывайте порт в брандмауэре для внешних подключений без необходимости
- Используйте сложные порты (не стандартные) для дополнительной безопасности

## Производительность

Благодаря оптимизации отправки данных:
- Минимальная нагрузка на сеть (данные только при изменениях)
- Низкая нагрузка на процессор (проверка изменений легкая)
- Актуальность данных (отправка при любых изменениях)

## Поддержка

При возникновении проблем:
1. Проверьте журнал терминала MT4 (Вид → Журнал)
2. Проверьте логи Python приложения
3. Убедитесь, что все файлы скопированы правильно
4. Проверьте версию MT4 (рекомендуется последняя)

## Версия

- **Версия EA**: 1.00
- **Совместимость**: MetaTrader 4 (все версии)
- **Требования**: Windows, разрешение на импорт DLL

