# Система множественных доноров

Этот модуль реализует поддержку множественных доноров для копировщика сделок MT5.

## Структура модуля

### Основные компоненты

- **`donor_base.py`** - Базовые классы для всех типов доноров
  - `DonorBase` - абстрактный базовый класс
  - `DonorPosition` - унифицированная структура позиции
  - `DonorOrder` - унифицированная структура ордера

- **`donor_manager.py`** - Менеджер всех доноров
  - Управление подключениями
  - Агрегация данных от всех доноров
  - Загрузка конфигурации

- **`donor_config_loader.py`** - Загрузчик конфигурации из JSON

### Реализации доноров

- **`donor_python_api.py`** - Донор через Python API MT5 (текущий метод)
- **`donor_socket_mt4.py`** - Донор через Socket MT4 (MQL4 EA)
- **`donor_socket_mt5.py`** - Донор через Socket MT5 (MQL5 EA)
- **`socket_client.py`** - Клиент для подключения к EA через TCP сокет

## Использование

### 1. Конфигурационный файл (рекомендуется)

По умолчанию система автоматически пытается загрузить файл `donors_config.json` из корня проекта.

Создайте файл `donors_config.json` на основе примера `donors_config.json.example`:

```json
{
  "donors": [
    {
      "id": "donor_mt5_api",
      "type": "python_api",
      "account_number": 12345678,
      "description": "Основной донор через Python API MT5"
    },
    {
      "id": "donor_mt5_socket_1",
      "type": "socket_mt5",
      "account_number": 87654321,
      "host": "localhost",
      "port": 8888,
      "description": "Первый донор MT5 через сокет"
    },
    {
      "id": "donor_mt5_socket_2",
      "type": "socket_mt5",
      "account_number": 11223344,
      "host": "localhost",
      "port": 8889,
      "description": "Второй донор MT5 через сокет"
    }
  ]
}
```

Запуск:
```bash
# Автоматическая загрузка donors_config.json из корня
python main.py

# Или указать другой файл
python main.py --donors-config custom_donors.json

# Игнорировать конфиг и использовать аргументы командной строки
python main.py --ignore-donor-config --donor-api 12345678
```

### 2. Быстрый запуск одного донора

```bash
# Python API
python main.py --donor-api 12345678

# Socket MT5
python main.py --donor-socket-mt5 12345678 --socket-port 8888

# Socket MT4
python main.py --donor-socket-mt4 12345678 --socket-port 8888
```

## Установка MQL4/MQL5 EA для сокет-доноров

### Для MT4

1. Скопируйте файл `DonorBroadcasterMT4.mq4` в папку `MQL4/Experts/` вашего терминала MT4
2. Откройте MetaEditor и скомпилируйте файл
3. В терминале MT4 перетащите EA на график любого символа
4. Настройте параметры:
   - `SocketPort` - порт для сокета (по умолчанию 8888)
   - `UpdateInterval` - интервал обновления в миллисекундах (по умолчанию 100)
5. Убедитесь, что "Разрешить автоматическую торговлю" включено

### Для MT5

1. Скопируйте файл `DonorBroadcasterMT5.mq5` в папку `MQL5/Experts/` вашего терминала MT5
2. Откройте MetaEditor и скомпилируйте файл
3. В терминале MT5 перетащите EA на график любого символа
4. Настройте параметры:
   - `SocketPort` - порт для сокета (по умолчанию 8888)
   - `UpdateInterval` - интервал обновления в миллисекундах (по умолчанию 100)
5. Убедитесь, что "Разрешить автоматическую торговлю" включено

### Важно

- Каждый EA должен использовать уникальный порт
- EA должен быть запущен на аккаунте, который указан в конфигурации
- EA работает как сервер и ожидает подключения от Python клиента
- При отключении клиента EA продолжает работать и ждет нового подключения

## Формат данных

EA транслирует данные в формате JSON:

```json
{
  "type": "positions",
  "timestamp": 1234567890,
  "account_info": {
    "login": 12345678,
    "balance": 10000.00,
    "equity": 10050.00,
    "server": "Broker-Demo"
  },
  "positions": [
    {
      "ticket": 123456,
      "symbol": "EURUSD",
      "type": 0,
      "volume": 0.10,
      "price_open": 1.08500,
      "price_current": 1.08550,
      "profit": 5.00,
      "time": 1234567890,
      "magic": 234000,
      "comment": "Comment"
    }
  ],
  "orders": [
    {
      "ticket": 789012,
      "symbol": "EURUSD",
      "type": 2,
      "volume": 0.10,
      "price_open": 1.08500,
      "time_setup": 1234567890
    }
  ]
}
```

## Протокол передачи

1. Клиент подключается к EA через TCP сокет
2. EA отправляет данные в следующем формате:
   - 4 байта (big-endian) - длина сообщения
   - N байт - JSON данные
3. Данные обновляются с интервалом `UpdateInterval` миллисекунд

## Отладка

Если EA не подключается:

1. Проверьте, что порт не занят другим приложением
2. Проверьте настройки брандмауэра Windows
3. Убедитесь, что EA запущен и виден в списке экспертов
4. Проверьте логи в журнале терминала (View -> Journal)

Если Python клиент не подключается:

1. Проверьте, что EA запущен и слушает порт
2. Проверьте правильность хоста и порта в конфигурации
3. Проверьте логи Python приложения

